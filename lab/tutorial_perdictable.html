
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pyg.base.join &#8212; pyg 0.0.1 documentation</title>
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="pyg.timeseries" href="tutorial_timeseries.html" />
    <link rel="prev" title="pyg.base.cell" href="tutorial_cell.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<div class="section" id="pyg.base.join">
<h1>pyg.base.join<a class="headerlink" href="#pyg.base.join" title="Permalink to this headline">¶</a></h1>
<p>Only read this if you are a seasoned dictable user. In data science, we usually have data in multiple tables and we want to pull specific columns together for an analysis. We will first look at <strong>join</strong> function and then examine the <strong>perdictable</strong> decorator.</p>
<div class="section" id="Join">
<h2>Join<a class="headerlink" href="#Join" title="Permalink to this headline">¶</a></h2>
<div class="section" id="Example:-Using-join-function-to-transfer-money-to-a-bank">
<h3>Example: Using join function to transfer money to a bank<a class="headerlink" href="#Example:-Using-join-function-to-transfer-money-to-a-bank" title="Permalink to this headline">¶</a></h3>
<p>We begin by setting up a mini database:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">pyg</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">customers</span> <span class="o">=</span> <span class="n">dictable</span><span class="p">(</span><span class="n">customer</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;alan&#39;</span><span class="p">,</span> <span class="s1">&#39;barbara&#39;</span><span class="p">,</span> <span class="s1">&#39;charles&#39;</span><span class="p">],</span> <span class="n">address</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;1 Abba Avenue&#39;</span><span class="p">,</span> <span class="s1">&#39;2 Beatles Lane&#39;</span><span class="p">,</span> <span class="s1">&#39;3 Corrs Close&#39;</span><span class="p">],</span> <span class="n">bank</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;allied&#39;</span><span class="p">,</span> <span class="s1">&#39;barclays&#39;</span><span class="p">,</span> <span class="s1">&#39;chase&#39;</span><span class="p">])</span>
<span class="n">products</span> <span class="o">=</span> <span class="n">dictable</span><span class="p">(</span><span class="n">product</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;apple&#39;</span><span class="p">,</span> <span class="s1">&#39;banana&#39;</span><span class="p">,</span> <span class="s1">&#39;cherry&#39;</span><span class="p">],</span> <span class="n">price</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">supplier</span>  <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;grove limited&#39;</span><span class="p">,</span> <span class="s1">&#39;go banabas&#39;</span><span class="p">,</span> <span class="s1">&#39;cherry pickers&#39;</span><span class="p">])</span>
<span class="n">customer_products</span> <span class="o">=</span> <span class="n">dictable</span><span class="p">(</span><span class="n">customer</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;alan&#39;</span><span class="p">,</span> <span class="s1">&#39;alan&#39;</span><span class="p">,</span> <span class="s1">&#39;charles&#39;</span><span class="p">,</span> <span class="s1">&#39;charles&#39;</span><span class="p">],</span> <span class="n">product</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;apple&#39;</span><span class="p">,</span> <span class="s1">&#39;banana&#39;</span><span class="p">,</span> <span class="s1">&#39;cherry&#39;</span><span class="p">,</span> <span class="s1">&#39;apple&#39;</span><span class="p">],</span> <span class="n">amount</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="n">purchase_date</span> <span class="o">=</span> <span class="n">drange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">banks</span> <span class="o">=</span> <span class="n">dictable</span><span class="p">(</span><span class="n">bank</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;allied&#39;</span><span class="p">,</span> <span class="s1">&#39;barclays&#39;</span><span class="p">],</span> <span class="n">account</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5556</span><span class="p">,</span> <span class="mi">2461</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Customers</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">customers</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Products</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">products</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Customer_products</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">customer_products</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Banks</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">banks</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Customers
 customer|address       |bank
alan    |1 Abba Avenue |allied
barbara |2 Beatles Lane|barclays
charles |3 Corrs Close |chase

Products
 product|price|supplier
apple  |1    |grove limited
banana |2    |go banabas
cherry |3    |cherry pickers

Customer_products
 customer|product|amount|purchase_date
alan    |apple  |1     |2021-02-23 00:00:00
alan    |banana |2     |2021-02-24 00:00:00
charles |cherry |3     |2021-02-25 00:00:00
charles |apple  |4     |2021-02-26 00:00:00

Banks
 bank    |account
allied  |5556
barclays|2461
</pre></div></div>
</div>
</div>
<div class="section" id="Simple-join:-inner-join-between-tables">
<h3>Simple join: inner join between tables<a class="headerlink" href="#Simple-join:-inner-join-between-tables" title="Permalink to this headline">¶</a></h3>
<p>Suppose we want to know how much money is to be transferred from each bank. - We only care about the fields ‘bank’, ‘amount’ and ‘price’ - each field is pulled from different tables, - need to specify customer &amp; product as the keys we will join on:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">join</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">bank</span> <span class="o">=</span> <span class="n">customers</span><span class="p">,</span> <span class="n">amount</span> <span class="o">=</span> <span class="n">customer_products</span><span class="p">,</span> <span class="n">price</span> <span class="o">=</span> <span class="n">products</span><span class="p">),</span> <span class="n">on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;customer&#39;</span><span class="p">,</span>  <span class="s1">&#39;product&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dictable[4 x 5]
product|customer|bank  |amount|price
apple  |alan    |allied|1     |1
banana |alan    |allied|2     |2
apple  |charles |chase |4     |1
cherry |charles |chase |3     |3
</pre></div></div>
</div>
</div>
<div class="section" id="Defaults-for-fields-we-want-to-left-join-on…">
<h3>Defaults for fields we want to left-join on…<a class="headerlink" href="#Defaults-for-fields-we-want-to-left-join-on…" title="Permalink to this headline">¶</a></h3>
<p>The function we need to run to transfer money looks like this, so actually, we would like to have account details too.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">transfer_money</span><span class="p">(</span><span class="n">bank</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">account</span> <span class="o">=</span> <span class="s1">&#39;default&#39;</span><span class="p">):</span>
    <span class="c1">## if account == &#39;default&#39; transfer money slowly, else transfer quickly</span>
    <span class="c1">## return</span>
    <span class="k">pass</span>
</pre></div>
</div>
</div>
<p>We can grab the account details from the ‘banks’ table:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">join</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">bank</span> <span class="o">=</span> <span class="n">customers</span><span class="p">,</span> <span class="n">amount</span> <span class="o">=</span> <span class="n">customer_products</span><span class="p">,</span> <span class="n">price</span> <span class="o">=</span> <span class="n">products</span><span class="p">,</span> <span class="n">account</span> <span class="o">=</span> <span class="n">banks</span><span class="p">),</span> <span class="n">on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;customer&#39;</span><span class="p">,</span>  <span class="s1">&#39;product&#39;</span><span class="p">,</span> <span class="s1">&#39;bank&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dictable[2 x 6]
bank  |product|customer|amount|price|account
allied|apple  |alan    |1     |1    |5556
allied|banana |alan    |2     |2    |5556
</pre></div></div>
</div>
<p>but we just <strong>lost</strong> Chase transactions as we dont have its account details. However, money is transfered perfectly (albeit slowly) even without account id. So instead….</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">join</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">bank</span> <span class="o">=</span> <span class="n">customers</span><span class="p">,</span> <span class="n">amount</span> <span class="o">=</span> <span class="n">customer_products</span><span class="p">,</span> <span class="n">price</span> <span class="o">=</span> <span class="n">products</span><span class="p">,</span> <span class="n">account</span> <span class="o">=</span> <span class="n">banks</span><span class="p">),</span>
     <span class="n">on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;customer&#39;</span><span class="p">,</span>  <span class="s1">&#39;product&#39;</span><span class="p">,</span> <span class="s1">&#39;bank&#39;</span><span class="p">],</span>
     <span class="n">defaults</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">account</span> <span class="o">=</span> <span class="s1">&#39;default&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dictable[4 x 6]
account|amount|bank  |customer|price|product
5556   |1     |allied|alan    |1    |apple
5556   |2     |allied|alan    |2    |banana
default|4     |chase |charles |1    |apple
default|3     |chase |charles |3    |cherry
</pre></div></div>
</div>
</div>
<div class="section" id="Renaming-&amp;-calculating-fields">
<h3>Renaming &amp; calculating fields<a class="headerlink" href="#Renaming-&-calculating-fields" title="Permalink to this headline">¶</a></h3>
<p>We also want to ensure we don’t transfer money that we already transferred… so we need to grab an expiry column based on purchase_date in customer_product table</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">join</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">bank</span> <span class="o">=</span> <span class="n">customers</span><span class="p">,</span> <span class="n">amount</span> <span class="o">=</span> <span class="n">customer_products</span><span class="p">,</span> <span class="n">price</span> <span class="o">=</span> <span class="n">products</span><span class="p">,</span> <span class="n">account</span> <span class="o">=</span> <span class="n">banks</span><span class="p">,</span> <span class="n">expiry</span> <span class="o">=</span> <span class="n">customer_products</span><span class="p">),</span>
     <span class="n">on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;customer&#39;</span><span class="p">,</span>  <span class="s1">&#39;product&#39;</span><span class="p">,</span> <span class="s1">&#39;bank&#39;</span><span class="p">],</span>
     <span class="n">renames</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">expiry</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">purchase_date</span><span class="p">:</span> <span class="n">dt</span><span class="p">(</span><span class="n">purchase_date</span><span class="p">,</span> <span class="s1">&#39;1b&#39;</span><span class="p">)),</span>  <span class="c1">## it takes 1 business day to transfer money</span>
     <span class="n">defaults</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">account</span> <span class="o">=</span> <span class="s1">&#39;default&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dictable[4 x 7]
account|amount|bank  |customer|expiry             |price|product
5556   |1     |allied|alan    |2021-02-24 00:00:00|1    |apple
5556   |2     |allied|alan    |2021-02-25 00:00:00|2    |banana
default|4     |chase |charles |2021-03-01 00:00:00|1    |apple
default|3     |chase |charles |2021-02-26 00:00:00|3    |cherry
</pre></div></div>
</div>
</div>
</div>
<div class="section" id="Perdictable">
<h2>Perdictable<a class="headerlink" href="#Perdictable" title="Permalink to this headline">¶</a></h2>
<p>perdictable takes the same operation one steps further and actually runs the function. We also use the function signature to determine the defaults parameter. Here is another example: ### Example: Oil prices In Finance, there are contracts called Futures, each Future contract has an expiry. E.g. Futures contracts for Oil are contracts agreeing the delivery of oil to a particular place in a particular month. Once that month is gone, that contract is no longer traded and the oil needs to be
delivered.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">pyg</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">oil</span> <span class="o">=</span> <span class="n">dictable</span><span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="n">dt</span><span class="p">()</span><span class="o">.</span><span class="n">year</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="o">+</span> <span class="n">dictable</span><span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="n">dt</span><span class="p">()</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">oil</span> <span class="o">=</span> <span class="n">oil</span><span class="p">(</span><span class="n">ticker</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="s1">&#39;OIL_</span><span class="si">%i</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">m</span> <span class="k">if</span> <span class="n">m</span><span class="o">&gt;</span><span class="mi">9</span> <span class="k">else</span> <span class="s1">&#39;0</span><span class="si">%i</span><span class="s1">&#39;</span><span class="o">%</span><span class="k">m</span>))
<span class="n">oil</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dictable[8 x 3]
m |y   |ticker
3 |2020|OIL_2020_03
6 |2020|OIL_2020_06
9 |2020|OIL_2020_09
...8 rows...
6 |2021|OIL_2021_06
9 |2021|OIL_2021_09
12|2021|OIL_2021_12
</pre></div></div>
</div>
<p>y,m and ticker will form our primary keys</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">pk</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;ticker&#39;</span><span class="p">]</span>
<span class="n">expiry</span> <span class="o">=</span> <span class="n">perdictable</span><span class="p">(</span><span class="k">lambda</span> <span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="n">dt</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">on</span> <span class="o">=</span> <span class="n">pk</span><span class="p">)(</span><span class="n">y</span> <span class="o">=</span> <span class="n">oil</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="n">oil</span><span class="p">)</span>
<span class="n">expiry</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dictable[8 x 4]
y   |m |ticker     |data
2020|3 |OIL_2020_03|2020-04-01 00:00:00
2020|6 |OIL_2020_06|2020-07-01 00:00:00
2020|9 |OIL_2020_09|2020-10-01 00:00:00
...8 rows...
2021|6 |OIL_2021_06|2021-07-01 00:00:00
2021|9 |OIL_2021_09|2021-10-01 00:00:00
2021|12|OIL_2021_12|2022-01-01 00:00:00
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">fake_ts</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="n">expiry</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">500</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="p">),</span> <span class="n">drange</span><span class="p">(</span><span class="n">dt_bump</span><span class="p">(</span><span class="n">expiry</span><span class="p">,</span><span class="o">-</span><span class="mi">99</span><span class="p">),</span> <span class="n">expiry</span><span class="p">))</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>To add a price for each of the futures, we first wrap fake_ts and then run it:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">price</span> <span class="o">=</span> <span class="n">perdictable</span><span class="p">(</span><span class="n">fake_ts</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="n">pk</span><span class="p">)(</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">oil</span><span class="p">,</span> <span class="n">expiry</span> <span class="o">=</span> <span class="n">expiry</span><span class="p">)</span>
<span class="n">price</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dictable[8 x 4]
y   |m |ticker     |data
2020|3 |OIL_2020_03|2019-12-24    499.000139
    |  |           |2019-12-25    500.904180
    |  |           |2019-12-26    501.792007
    |  |           |2019-12-27    502.410313
    |  |           |2019-12-28    502.843697
2020|6 |OIL_2020_06|2020-03-24    500.575052
    |  |           |2020-03-25    499.504860
    |  |           |2020-03-26    500.558506
    |  |           |2020-03-27    500.599754
    |  |           |2020-03-28    500.704313
2020|9 |OIL_2020_09|2020-06-24    500.333677
    |  |           |2020-06-25    500.974220
    |  |           |2020-06-26    499.882500
    |  |           |2020-06-27    500.342359
    |  |           |2020-06-28    501.423622
...8 rows...
2021|6 |OIL_2021_06|2021-03-24    501.437903
    |  |           |2021-03-25    500.808820
    |  |           |2021-03-26    499.478861
    |  |           |2021-03-27    499.203311
    |  |           |2021-03-28    498.270609
2021|9 |OIL_2021_09|2021-06-24    499.950777
    |  |           |2021-06-25    500.458993
    |  |           |2021-06-26    498.564582
    |  |           |2021-06-27    497.988147
    |  |           |2021-06-28    498.193692
2021|12|OIL_2021_12|2021-09-24    500.320503
    |  |           |2021-09-25    499.915132
    |  |           |2021-09-26    498.200049
    |  |           |2021-09-27    497.805575
    |  |           |2021-09-28    497.879972
</pre></div></div>
</div>
<p>We have wrapped a function so that we get a price for <strong>each</strong> of these contracts. This allows us to move from operating on single timeseries, to run it on multiple rows from multiple tables</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rtn</span> <span class="o">=</span> <span class="n">perdictable</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="n">pk</span><span class="p">)(</span><span class="n">a</span> <span class="o">=</span> <span class="n">price</span><span class="p">,</span> <span class="n">expiry</span> <span class="o">=</span> <span class="n">expiry</span><span class="p">)</span>
<span class="n">yesterday_price</span> <span class="o">=</span> <span class="n">perdictable</span><span class="p">(</span><span class="n">shift</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="n">pk</span><span class="p">)(</span><span class="n">a</span> <span class="o">=</span> <span class="n">price</span><span class="p">,</span> <span class="n">expiry</span> <span class="o">=</span> <span class="n">expiry</span><span class="p">)</span>
<span class="n">percentage_return</span> <span class="o">=</span> <span class="n">perdictable</span><span class="p">(</span><span class="n">div_</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="n">pk</span><span class="p">)(</span><span class="n">a</span> <span class="o">=</span> <span class="n">rtn</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">yesterday_price</span><span class="p">,</span> <span class="n">expiry</span> <span class="o">=</span> <span class="n">expiry</span><span class="p">)</span>
<span class="n">percentage_return</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dictable[8 x 4]
y   |m |ticker     |data
2020|3 |OIL_2020_03|2019-12-24         NaN
    |  |           |2019-12-25    0.003816
    |  |           |2019-12-26    0.001772
    |  |           |2019-12-27    0.001232
    |  |           |2019-12-28    0.000863
2020|6 |OIL_2020_06|2020-03-24         NaN
    |  |           |2020-03-25   -0.002138
    |  |           |2020-03-26    0.002109
    |  |           |2020-03-27    0.000082
    |  |           |2020-03-28    0.000209
2020|9 |OIL_2020_09|2020-06-24         NaN
    |  |           |2020-06-25    0.001280
    |  |           |2020-06-26   -0.002179
    |  |           |2020-06-27    0.000920
    |  |           |2020-06-28    0.002161
...8 rows...
2021|6 |OIL_2021_06|2021-03-24         NaN
    |  |           |2021-03-25   -0.001255
    |  |           |2021-03-26   -0.002656
    |  |           |2021-03-27   -0.000552
    |  |           |2021-03-28   -0.001868
2021|9 |OIL_2021_09|2021-06-24         NaN
    |  |           |2021-06-25    0.001017
    |  |           |2021-06-26   -0.003785
    |  |           |2021-06-27   -0.001156
    |  |           |2021-06-28    0.000413
2021|12|OIL_2021_12|2021-09-24         NaN
    |  |           |2021-09-25   -0.000810
    |  |           |2021-09-26   -0.003431
    |  |           |2021-09-27   -0.000792
    |  |           |2021-09-28    0.000149
</pre></div></div>
</div>
<div class="section" id="perdictable-and-caching">
<h3>perdictable and caching<a class="headerlink" href="#perdictable-and-caching" title="Permalink to this headline">¶</a></h3>
<p>This is nice but (a) what have we gained? and (b) why do we keep using expiry as a variable? The answer is to do with caching actually. If we rerun prices, we should get brand new data, since fake_ts just generates random prices… perdictable identifies rows that have been run and are now ‘expired’ It uses provided old data and does not recalculate. If either expiry or old values are not provided then it calculates everything.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">new_price</span> <span class="o">=</span> <span class="n">perdictable</span><span class="p">(</span><span class="n">fake_ts</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="n">pk</span><span class="p">)(</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">oil</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">price</span><span class="p">,</span> <span class="n">expiry</span> <span class="o">=</span> <span class="n">expiry</span><span class="p">)</span>
<span class="p">(</span><span class="n">new_price</span><span class="o">.</span><span class="n">relabel</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="s1">&#39;new&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">price</span><span class="o">.</span><span class="n">relabel</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="s1">&#39;old&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dictable[8 x 5]
y   |m |ticker     |new                     |old
2020|3 |OIL_2020_03|2019-12-24    499.000139|2019-12-24    499.000139
    |  |           |2019-12-25    500.904180|2019-12-25    500.904180
    |  |           |2019-12-26    501.792007|2019-12-26    501.792007
    |  |           |2019-12-27    502.410313|2019-12-27    502.410313
    |  |           |2019-12-28    502.843697|2019-12-28    502.843697
2020|6 |OIL_2020_06|2020-03-24    500.575052|2020-03-24    500.575052
    |  |           |2020-03-25    499.504860|2020-03-25    499.504860
    |  |           |2020-03-26    500.558506|2020-03-26    500.558506
    |  |           |2020-03-27    500.599754|2020-03-27    500.599754
    |  |           |2020-03-28    500.704313|2020-03-28    500.704313
2020|9 |OIL_2020_09|2020-06-24    500.333677|2020-06-24    500.333677
    |  |           |2020-06-25    500.974220|2020-06-25    500.974220
    |  |           |2020-06-26    499.882500|2020-06-26    499.882500
    |  |           |2020-06-27    500.342359|2020-06-27    500.342359
    |  |           |2020-06-28    501.423622|2020-06-28    501.423622
...8 rows...
2021|6 |OIL_2021_06|2021-03-24    500.429724|2021-03-24    501.437903
    |  |           |2021-03-25    501.537890|2021-03-25    500.808820
    |  |           |2021-03-26    501.167511|2021-03-26    499.478861
    |  |           |2021-03-27    502.611689|2021-03-27    499.203311
    |  |           |2021-03-28    501.820261|2021-03-28    498.270609
2021|9 |OIL_2021_09|2021-06-24    499.911914|2021-06-24    499.950777
    |  |           |2021-06-25    497.451472|2021-06-25    500.458993
    |  |           |2021-06-26    498.190816|2021-06-26    498.564582
    |  |           |2021-06-27    498.015362|2021-06-27    497.988147
    |  |           |2021-06-28    497.224958|2021-06-28    498.193692
2021|12|OIL_2021_12|2021-09-24    498.129511|2021-09-24    500.320503
    |  |           |2021-09-25    498.739546|2021-09-25    499.915132
    |  |           |2021-09-26    499.321094|2021-09-26    498.200049
    |  |           |2021-09-27    498.491587|2021-09-27    497.805575
    |  |           |2021-09-28    497.057529|2021-09-28    497.879972
</pre></div></div>
</div>
</div>
<div class="section" id="perdictable-with-the-cell-framework">
<h3>perdictable with the cell framework<a class="headerlink" href="#perdictable-with-the-cell-framework" title="Permalink to this headline">¶</a></h3>
<p>We can run the function and use a cell to store the output…</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">c</span> <span class="o">=</span> <span class="n">cell</span><span class="p">(</span><span class="n">perdictable</span><span class="p">(</span><span class="n">fake_ts</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="n">pk</span><span class="p">),</span> <span class="n">ticker</span> <span class="o">=</span> <span class="n">oil</span><span class="p">,</span> <span class="n">expiry</span> <span class="o">=</span> <span class="n">expiry</span><span class="p">)()</span>
<span class="n">c</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dictable[8 x 4]
y   |m |ticker     |data
2020|3 |OIL_2020_03|2019-12-24    501.331417
    |  |           |2019-12-25    500.332873
    |  |           |2019-12-26    500.160526
    |  |           |2019-12-27    496.688779
    |  |           |2019-12-28    497.774215
2020|6 |OIL_2020_06|2020-03-24    500.899756
    |  |           |2020-03-25    500.830490
    |  |           |2020-03-26    501.829020
    |  |           |2020-03-27    501.875464
    |  |           |2020-03-28    503.241949
2020|9 |OIL_2020_09|2020-06-24    500.395880
    |  |           |2020-06-25    500.311780
    |  |           |2020-06-26    499.817331
    |  |           |2020-06-27    499.780468
    |  |           |2020-06-28    497.550235
...8 rows...
2021|6 |OIL_2021_06|2021-03-24    501.291426
    |  |           |2021-03-25    499.592175
    |  |           |2021-03-26    499.104934
    |  |           |2021-03-27    497.698320
    |  |           |2021-03-28    497.868177
2021|9 |OIL_2021_09|2021-06-24    499.978264
    |  |           |2021-06-25    500.784927
    |  |           |2021-06-26    501.212177
    |  |           |2021-06-27    501.852472
    |  |           |2021-06-28    502.035097
2021|12|OIL_2021_12|2021-09-24    500.282482
    |  |           |2021-09-25    501.077309
    |  |           |2021-09-26    501.005312
    |  |           |2021-09-27    501.173168
    |  |           |2021-09-28    502.098126
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">recalculated_cell</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">go</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">## force a recalculation</span>
<span class="n">recalculated_cell</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dictable[8 x 4]
y   |m |ticker     |data
2020|3 |OIL_2020_03|2019-12-24    501.331417
    |  |           |2019-12-25    500.332873
    |  |           |2019-12-26    500.160526
    |  |           |2019-12-27    496.688779
    |  |           |2019-12-28    497.774215
2020|6 |OIL_2020_06|2020-03-24    500.899756
    |  |           |2020-03-25    500.830490
    |  |           |2020-03-26    501.829020
    |  |           |2020-03-27    501.875464
    |  |           |2020-03-28    503.241949
2020|9 |OIL_2020_09|2020-06-24    500.395880
    |  |           |2020-06-25    500.311780
    |  |           |2020-06-26    499.817331
    |  |           |2020-06-27    499.780468
    |  |           |2020-06-28    497.550235
...8 rows...
2021|6 |OIL_2021_06|2021-03-24    499.383712
    |  |           |2021-03-25    498.812289
    |  |           |2021-03-26    498.995159
    |  |           |2021-03-27    499.504985
    |  |           |2021-03-28    498.453581
2021|9 |OIL_2021_09|2021-06-24    499.310726
    |  |           |2021-06-25    500.248325
    |  |           |2021-06-26    500.458067
    |  |           |2021-06-27    498.482094
    |  |           |2021-06-28    499.704684
2021|12|OIL_2021_12|2021-09-24    501.359202
    |  |           |2021-09-25    501.178162
    |  |           |2021-09-26    501.846290
    |  |           |2021-09-27    502.217393
    |  |           |2021-09-28    500.996568
</pre></div></div>
</div>
<p>We observe that the cell, when recalculates, automatically caches the history and does not recalculate fake_ts. This is not magic. When a cell calculates its function, it provides the function with the variables it needs. Once calculated, it stores the output in <strong>data</strong> and will be able to provide <strong>data</strong> to the function next time, allowing it to avoid re-running expired calculations. Then cell will store the functions’s result back in the <strong>data</strong> key for later use and this is repeated.</p>
</div>
<div class="section" id="perdictable-API">
<h3>perdictable API<a class="headerlink" href="#perdictable-API" title="Permalink to this headline">¶</a></h3>
<p>Parameters <strong>on</strong>, <strong>renames</strong> and <strong>defaults</strong> parameters determine the way the data is joined. If defaults is missing, the defaults from the function are used:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">function</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">price</span><span class="p">,</span> <span class="n">quantity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span> <span class="n">price</span> <span class="o">*</span> <span class="n">quantity</span>
<span class="n">price</span> <span class="o">=</span> <span class="n">dictable</span><span class="p">(</span><span class="n">product</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;apple&#39;</span><span class="p">,</span> <span class="s1">&#39;banana&#39;</span><span class="p">,</span> <span class="s1">&#39;cherry&#39;</span><span class="p">],</span> <span class="n">price</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
<span class="n">quantity</span> <span class="o">=</span> <span class="n">dictable</span><span class="p">(</span><span class="n">product</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;apple&#39;</span><span class="p">,</span> <span class="s1">&#39;banana&#39;</span><span class="p">,</span> <span class="s1">&#39;damson&#39;</span><span class="p">],</span> <span class="n">quantity</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>
<span class="n">perdictable</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s1">&#39;product&#39;</span><span class="p">)(</span><span class="n">price</span> <span class="o">=</span> <span class="n">price</span><span class="p">,</span> <span class="n">quantity</span> <span class="o">=</span> <span class="n">quantity</span><span class="p">)</span> <span class="c1">## cherry should appear with default quantity</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dictable[3 x 2]
product|data
apple  |2
banana |6
cherry |3
</pre></div></div>
</div>
<p>If you want to see the full calculations and inputs to the function set <strong>include_inputs</strong>=True:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">perdictable</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s1">&#39;product&#39;</span><span class="p">,</span> <span class="n">include_inputs</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)(</span><span class="n">price</span> <span class="o">=</span> <span class="n">price</span><span class="p">,</span> <span class="n">quantity</span> <span class="o">=</span> <span class="n">quantity</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dictable[3 x 5]
price|product|quantity|expiry|data
1    |apple  |2       |None  |2
2    |banana |3       |None  |6
3    |cherry |1       |None  |3
</pre></div></div>
</div>
<p>If you want output column to be not data, use <strong>col</strong>:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">perdictable</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s1">&#39;product&#39;</span><span class="p">,</span> <span class="n">include_inputs</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s1">&#39;cost&#39;</span><span class="p">)(</span><span class="n">price</span> <span class="o">=</span> <span class="n">price</span><span class="p">,</span> <span class="n">quantity</span> <span class="o">=</span> <span class="n">quantity</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dictable[3 x 5]
price|product|quantity|expiry|cost
1    |apple  |2       |None  |2
2    |banana |3       |None  |6
3    |cherry |1       |None  |3
</pre></div></div>
</div>
<p>The <strong>if_none</strong> parameter determines how data is calculated for rows that have expired but their data is None:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[52]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">expiry</span> <span class="o">=</span> <span class="n">dictable</span><span class="p">(</span><span class="n">product</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;apple&#39;</span><span class="p">,</span> <span class="s1">&#39;banana&#39;</span><span class="p">,</span> <span class="s1">&#39;cherry&#39;</span><span class="p">],</span> <span class="n">expiry</span> <span class="o">=</span> <span class="p">[</span><span class="n">dt</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">),</span> <span class="n">dt</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">dt</span><span class="p">(</span><span class="mi">1</span><span class="p">)])</span>
<span class="n">previous_data</span> <span class="o">=</span> <span class="n">dictable</span><span class="p">(</span><span class="n">product</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;apple&#39;</span><span class="p">,</span> <span class="s1">&#39;banana&#39;</span><span class="p">,</span> <span class="s1">&#39;cherry&#39;</span><span class="p">],</span> <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;some value that will be kept&#39;</span><span class="p">,</span> <span class="s1">&#39;this value will be recalculated&#39;</span><span class="p">])</span>
<span class="n">perdictable</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s1">&#39;product&#39;</span><span class="p">,</span> <span class="n">include_inputs</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">if_none</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)(</span><span class="n">price</span> <span class="o">=</span> <span class="n">price</span><span class="p">,</span> <span class="n">quantity</span> <span class="o">=</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">expiry</span> <span class="o">=</span> <span class="n">expiry</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">previous_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[52]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dictable[3 x 5]
expiry             |price|product|quantity|data
2021-02-24 00:00:00|1    |apple  |2       |None
2021-02-25 00:00:00|2    |banana |3       |some value that will be kept
2021-02-27 00:00:00|3    |cherry |1       |3
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">perdictable</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s1">&#39;product&#39;</span><span class="p">,</span> <span class="n">include_inputs</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">if_none</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)(</span><span class="n">price</span> <span class="o">=</span> <span class="n">price</span><span class="p">,</span> <span class="n">quantity</span> <span class="o">=</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">expiry</span> <span class="o">=</span> <span class="n">expiry</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">previous_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dictable[3 x 5]
expiry             |price|product|quantity|data
2021-02-24 00:00:00|1    |apple  |2       |2
2021-02-25 00:00:00|2    |banana |3       |some value that will be kept
2021-02-27 00:00:00|3    |cherry |1       |3
</pre></div></div>
</div>
<p>Some function want to receive historic data and they use it themselves. Parameter <strong>output_is_input</strong> controls this. For example: If your function is pulling historic prices from yahoo finance, you can use existing data to ask yahoo for only recent ones.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[54]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">running_total_costs</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">quantity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">data</span> <span class="o">+</span> <span class="n">price</span> <span class="o">*</span> <span class="n">quantity</span>

<span class="n">previous_data</span> <span class="o">=</span> <span class="n">dictable</span><span class="p">(</span><span class="n">product</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;apple&#39;</span><span class="p">,</span> <span class="s1">&#39;banana&#39;</span><span class="p">,</span> <span class="s1">&#39;cherry&#39;</span><span class="p">,</span> <span class="s1">&#39;damson&#39;</span><span class="p">],</span> <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">])</span>
<span class="n">perdictable</span><span class="p">(</span><span class="n">running_total_costs</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s1">&#39;product&#39;</span><span class="p">,</span> <span class="n">include_inputs</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)(</span><span class="n">price</span> <span class="o">=</span> <span class="n">price</span><span class="p">,</span> <span class="n">quantity</span> <span class="o">=</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">previous_data</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[54]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dictable[3 x 5]
price|product|quantity|expiry|data
1    |apple  |2       |None  |12
2    |banana |3       |None  |26
3    |cherry |1       |None  |33
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[57]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">## if you don&#39;t want existing data to be presented to the function:</span>
<span class="n">perdictable</span><span class="p">(</span><span class="n">running_total_costs</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s1">&#39;product&#39;</span><span class="p">,</span> <span class="n">include_inputs</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">output_is_input</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)(</span><span class="n">price</span> <span class="o">=</span> <span class="n">price</span><span class="p">,</span> <span class="n">quantity</span> <span class="o">=</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">previous_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[57]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dictable[3 x 5]
price|product|quantity|expiry|data
1    |apple  |2       |None  |2
2    |banana |3       |None  |6
3    |cherry |1       |None  |3
</pre></div></div>
</div>
</div>
</div>
<div class="section" id="Conclusions">
<h2>Conclusions<a class="headerlink" href="#Conclusions" title="Permalink to this headline">¶</a></h2>
<p>pyg.base.join allows us to create joined table with the variables we need. This is leveraged by perdictable so that the ‘atomic’ data we work with is not a single timeseries but a whole table of timeseries data indexed by some keys. We can use various perdictable parameters to control cache policy. All this is done with very little additional code, allowing us to manage quite a lot of data items with very little effort while managing caching expired items.</p>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">pyg</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../includeme.html">README</a></li>
<li class="toctree-l1"><a class="reference internal" href="../base.html">pyg.base</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mongo.html">pyg.mongo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timeseries.html">pyg.timeseries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_dict.html">pyg.base.Dict</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_dictable.html">pyg.base.dictable</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_mongo.html">pyg.mongo</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_cell.html">pyg.base.cell</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">pyg.base.join</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Join">Join</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Example:-Using-join-function-to-transfer-money-to-a-bank">Example: Using join function to transfer money to a bank</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Simple-join:-inner-join-between-tables">Simple join: inner join between tables</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Defaults-for-fields-we-want-to-left-join-on…">Defaults for fields we want to left-join on…</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Renaming-&amp;-calculating-fields">Renaming &amp; calculating fields</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Perdictable">Perdictable</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#perdictable-and-caching">perdictable and caching</a></li>
<li class="toctree-l3"><a class="reference internal" href="#perdictable-with-the-cell-framework">perdictable with the cell framework</a></li>
<li class="toctree-l3"><a class="reference internal" href="#perdictable-API">perdictable API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Conclusions">Conclusions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_timeseries.html">pyg.timeseries</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_ts_decorators.html">pyg.timeseries decorators</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_ts_ewma_time.html">pyg.timeseries.ewma</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="tutorial_cell.html" title="previous chapter">pyg.base.cell</a></li>
      <li>Next: <a href="tutorial_timeseries.html" title="next chapter">pyg.timeseries</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Yoav Git.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.4.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/lab/tutorial_perdictable.ipynb.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>