
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pyg.timeseries &#8212; pyg 0.0.1 documentation</title>
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="pyg.timeseries decorators" href="tutorial_ts_decorators.html" />
    <link rel="prev" title="pyg.base.join" href="tutorial_perdictable.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<div class="section" id="pyg.timeseries">
<h1>pyg.timeseries<a class="headerlink" href="#pyg.timeseries" title="Permalink to this headline">¶</a></h1>
<p>Given pandas, why do we need this timeseries library? pandas is amazing but there are a few features in pyg.timeseries designed to enhance it.</p>
<p>There are three issues with pandas that pyg.timeseries tries to address:</p>
<ul class="simple">
<li><p>pandas works on pandas objects (obviously) but not on numpy arrays.</p></li>
<li><p>pandas handles nan within timeseries inconsistently across its functions. This makes your results sensitive to reindexing/resampling. E.g.:</p>
<ul>
<li><p>a.expanding() &amp; a.ewm() <strong>ignore</strong> nan’s for calculation and then forward-fill the result.</p></li>
<li><p>a.diff(), a.rolling() <strong>include</strong> any nans in the calculation, leading to nan propagation.</p></li>
</ul>
</li>
<li><p>pandas is great if you have the full timeseries. However, if you now want to run the same calculations in a live environment, on recent data, you have to append recent data at the end of the DataFrame and rerun.</p></li>
</ul>
<p>pyg.timeseries tries to address this:</p>
<ul class="simple">
<li><p>pyg.timeseries agrees with pandas 100% (if there are no nan in the dataframe) while being of comparable speed</p></li>
<li><p>pyg.timeseries works seemlessly on pandas objects and on numpy arrays, with no code change.</p></li>
<li><p>pyg.timeseries handles nan consistently across all its functions, ‘ignoring’ all nan, making your results consistent regardless of reindexing/resampling.</p></li>
<li><p>pyg.timeseries exposes the state of the internal function calculation. The exposure of internal state allows us to calculate the output of additional data <strong>without</strong> re-running history. This speeds up of two very common problems in finance:</p>
<ul>
<li><p>risk calculations, Monte Carlo scenarios: We can run a trading strategy up to today and then generate multiple scenarios and see what-if, without having to rerun the full history.</p></li>
<li><p>live versus history: pandas is designed to run a full historical simulation. However, once we reach “today”, speed is of the essense and running a full historical simulation every time we ingest a new price, is just too slow. That is why most fast trading is built around fast state-machines. Of course, making sure research &amp; live versions do the same thing is tricky. pyg gives you the ability to run two systems in parallel with almost the same code base: run full history overnight and then
run today’s code base instantly, instantiated with the output of the historical simulation.</p></li>
</ul>
</li>
</ul>
<div class="section" id="Agreement-between-pyg.timeseries-and-pandas">
<h2>Agreement between pyg.timeseries and pandas<a class="headerlink" href="#Agreement-between-pyg.timeseries-and-pandas" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">pyg</span> <span class="kn">import</span> <span class="o">*</span><span class="p">;</span> <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span><span class="p">;</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">10000</span><span class="p">),</span> <span class="n">drange</span><span class="p">(</span><span class="o">-</span><span class="mi">9999</span><span class="p">));</span> <span class="n">a</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">values</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">10000</span><span class="p">),</span> <span class="n">drange</span><span class="p">(</span><span class="o">-</span><span class="mi">9999</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts_count</span><span class="p">(</span><span class="n">s</span><span class="p">))</span><span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts_mean</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>  <span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="o">-</span> <span class="n">ts_sum</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>   <span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>  <span class="o">-</span> <span class="n">ts_std</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>   <span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">skew</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts_skew</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>  <span class="o">&lt;</span> <span class="mf">1e-10</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ewma</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>       <span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ewmstd</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">())</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>      <span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ewmvar</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">())</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>      <span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ewmcor</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">t</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">1e-10</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">expanding_sum</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">expanding</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>            <span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">expanding_mean</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">expanding</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>          <span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">expanding_std</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">expanding</span><span class="p">()</span><span class="o">.</span><span class="n">std</span><span class="p">())</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>            <span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">expanding_skew</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">expanding</span><span class="p">()</span><span class="o">.</span><span class="n">skew</span><span class="p">())</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>          <span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">expanding_min</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">expanding</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>            <span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">expanding_max</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">expanding</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>            <span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">expanding_median</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">expanding</span><span class="p">()</span><span class="o">.</span><span class="n">median</span><span class="p">())</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>      <span class="o">&lt;</span> <span class="mf">1e-10</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rolling_sum</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>                        <span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rolling_mean</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>                      <span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rolling_std</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">())</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>                        <span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rolling_skew</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">skew</span><span class="p">())</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>                      <span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rolling_min</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>                        <span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rolling_max</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>                        <span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rolling_median</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">())</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>                  <span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rolling_quantile</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mf">0.3</span><span class="p">)[</span><span class="mf">0.3</span><span class="p">]</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.3</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>  <span class="o">&lt;</span> <span class="mf">1e-10</span> <span class="c1">## The rolling_quantile returns the quantile as the header, since it supports multiple quantiles calculations: e.g. rolling_quantile(s,10,[0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9])</span>
</pre></div>
</div>
</div>
<div class="section" id="Quick-performance-comparison">
<h3>Quick performance comparison<a class="headerlink" href="#Quick-performance-comparison" title="Permalink to this headline">¶</a></h3>
<p>pyg, when run on pandas dataframes rather than arrays, is of comparable speed to pandas</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">compare</span> <span class="o">=</span> <span class="n">dictable</span><span class="p">(</span><span class="n">op</span> <span class="o">=</span>  <span class="p">[</span><span class="s1">&#39;rolling_sum&#39;</span><span class="p">,</span> <span class="s1">&#39;rolling_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;rolling_std&#39;</span><span class="p">,</span> <span class="s1">&#39;rolling_min&#39;</span><span class="p">,</span> <span class="s1">&#39;rolling_median&#39;</span><span class="p">],</span>
             <span class="n">pyg</span> <span class="o">=</span> <span class="p">[</span><span class="n">rolling_sum</span><span class="p">,</span> <span class="n">rolling_mean</span><span class="p">,</span> <span class="n">rolling_std</span><span class="p">,</span> <span class="n">rolling_min</span><span class="p">,</span> <span class="n">rolling_median</span><span class="p">],</span>
             <span class="n">pandas</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">])</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">timer</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">time</span> <span class="o">=</span> <span class="kc">True</span><span class="p">),</span> <span class="s1">&#39;pyg&#39;</span><span class="p">,</span> <span class="s1">&#39;pandas&#39;</span><span class="p">)(</span><span class="n">pyg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">pyg</span><span class="p">:</span> <span class="n">pyg</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">10</span><span class="p">))(</span><span class="n">pandas</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">pandas</span><span class="p">:</span> <span class="n">pandas</span><span class="p">())</span>

<span class="n">compare</span> <span class="o">+=</span> <span class="n">dictable</span><span class="p">(</span><span class="n">op</span> <span class="o">=</span>  <span class="p">[</span><span class="s1">&#39;expanding_sum&#39;</span><span class="p">,</span> <span class="s1">&#39;expanding_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;expanding_std&#39;</span><span class="p">,</span> <span class="s1">&#39;expanding_min&#39;</span><span class="p">,</span> <span class="s1">&#39;expanding_median&#39;</span><span class="p">],</span>
             <span class="n">pyg</span> <span class="o">=</span> <span class="p">[</span><span class="n">expanding_sum</span><span class="p">,</span> <span class="n">expanding_mean</span><span class="p">,</span> <span class="n">expanding_std</span><span class="p">,</span> <span class="n">expanding_min</span><span class="p">,</span> <span class="n">expanding_median</span><span class="p">],</span>
             <span class="n">pandas</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">expanding</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">expanding</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">expanding</span><span class="p">()</span><span class="o">.</span><span class="n">std</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">expanding</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">expanding</span><span class="p">()</span><span class="o">.</span><span class="n">median</span><span class="p">])</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">timer</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">time</span> <span class="o">=</span> <span class="kc">True</span><span class="p">),</span> <span class="s1">&#39;pyg&#39;</span><span class="p">,</span> <span class="s1">&#39;pandas&#39;</span><span class="p">)(</span><span class="n">pyg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">pyg</span><span class="p">:</span> <span class="n">pyg</span><span class="p">(</span><span class="n">s</span><span class="p">))(</span><span class="n">pandas</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">pandas</span><span class="p">:</span> <span class="n">pandas</span><span class="p">())</span>

<span class="n">compare</span> <span class="o">+=</span> <span class="n">dictable</span><span class="p">(</span><span class="n">op</span> <span class="o">=</span>  <span class="p">[</span><span class="s1">&#39;ewma&#39;</span><span class="p">,</span> <span class="s1">&#39;ewmstd&#39;</span><span class="p">,</span> <span class="s1">&#39;ewmvar&#39;</span><span class="p">],</span>
             <span class="n">pyg</span> <span class="o">=</span> <span class="p">[</span><span class="n">ewma</span><span class="p">,</span> <span class="n">ewmstd</span><span class="p">,</span> <span class="n">ewmvar</span><span class="p">],</span>
             <span class="n">pandas</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">])</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">timer</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">time</span> <span class="o">=</span> <span class="kc">True</span><span class="p">),</span> <span class="s1">&#39;pyg&#39;</span><span class="p">,</span> <span class="s1">&#39;pandas&#39;</span><span class="p">)(</span><span class="n">pyg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">pyg</span><span class="p">:</span> <span class="n">pyg</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">10</span><span class="p">))(</span><span class="n">pandas</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">pandas</span><span class="p">:</span> <span class="n">pandas</span><span class="p">())</span>

<span class="nb">print</span><span class="p">(</span><span class="n">compare</span><span class="p">(</span><span class="n">winner</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">pyg</span><span class="p">,</span> <span class="n">pandas</span><span class="p">:</span> <span class="s1">&#39;pyg&#39;</span> <span class="k">if</span> <span class="n">pyg</span><span class="o">&lt;</span><span class="n">pandas</span> <span class="o">*</span> <span class="mf">0.8</span> <span class="k">else</span> <span class="s1">&#39;pandas&#39;</span> <span class="k">if</span> <span class="n">pyg</span> <span class="o">&gt;</span> <span class="mf">1.2</span> <span class="o">*</span> <span class="n">pandas</span> <span class="k">else</span> <span class="s1">&#39;draw&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
2021-03-06 22:41:35,805 - pyg - INFO - TIMER:&#39;rolling_sum&#39; args:[[&#34;&lt;class &#39;pandas.core.series.Series&#39;&gt;[10000]&#34;, &#39;10&#39;], []] (100 runs) took 0:00:00.109934 sec
2021-03-06 22:41:35,898 - pyg - INFO - TIMER:&#39;rolling_mean&#39; args:[[&#34;&lt;class &#39;pandas.core.series.Series&#39;&gt;[10000]&#34;, &#39;10&#39;], []] (100 runs) took 0:00:00.087950 sec
2021-03-06 22:41:35,995 - pyg - INFO - TIMER:&#39;rolling_std&#39; args:[[&#34;&lt;class &#39;pandas.core.series.Series&#39;&gt;[10000]&#34;, &#39;10&#39;], []] (100 runs) took 0:00:00.090944 sec
2021-03-06 22:41:36,116 - pyg - INFO - TIMER:&#39;rolling_min&#39; args:[[&#34;&lt;class &#39;pandas.core.series.Series&#39;&gt;[10000]&#34;, &#39;10&#39;], []] (100 runs) took 0:00:00.119930 sec
2021-03-06 22:41:36,269 - pyg - INFO - TIMER:&#39;rolling_median&#39; args:[[&#34;&lt;class &#39;pandas.core.series.Series&#39;&gt;[10000]&#34;, &#39;10&#39;], []] (100 runs) took 0:00:00.153483 sec
2021-03-06 22:41:36,351 - pyg - INFO - TIMER:&#39;sum&#39; args:[[], []] (100 runs) took 0:00:00.079685 sec
2021-03-06 22:41:36,465 - pyg - INFO - TIMER:&#39;mean&#39; args:[[], []] (100 runs) took 0:00:00.112599 sec
2021-03-06 22:41:36,585 - pyg - INFO - TIMER:&#39;std&#39; args:[[], []] (100 runs) took 0:00:00.119877 sec
2021-03-06 22:41:36,687 - pyg - INFO - TIMER:&#39;min&#39; args:[[], []] (100 runs) took 0:00:00.100942 sec
2021-03-06 22:41:37,378 - pyg - INFO - TIMER:&#39;median&#39; args:[[], []] (100 runs) took 0:00:00.688107 sec
2021-03-06 22:41:37,467 - pyg - INFO - TIMER:&#39;expanding_sum&#39; args:[[&#34;&lt;class &#39;pandas.core.series.Series&#39;&gt;[10000]&#34;], []] (100 runs) took 0:00:00.086951 sec
2021-03-06 22:41:37,528 - pyg - INFO - TIMER:&#39;expanding_mean&#39; args:[[&#34;&lt;class &#39;pandas.core.series.Series&#39;&gt;[10000]&#34;], []] (100 runs) took 0:00:00.059966 sec
2021-03-06 22:41:37,651 - pyg - INFO - TIMER:&#39;expanding_std&#39; args:[[&#34;&lt;class &#39;pandas.core.series.Series&#39;&gt;[10000]&#34;], []] (100 runs) took 0:00:00.120938 sec
2021-03-06 22:41:37,695 - pyg - INFO - TIMER:&#39;expanding_min&#39; args:[[&#34;&lt;class &#39;pandas.core.series.Series&#39;&gt;[10000]&#34;], []] (100 runs) took 0:00:00.040991 sec
2021-03-06 22:41:37,903 - pyg - INFO - TIMER:&#39;expanding_median&#39; args:[[&#34;&lt;class &#39;pandas.core.series.Series&#39;&gt;[10000]&#34;], []] (100 runs) took 0:00:00.206892 sec
2021-03-06 22:41:37,939 - pyg - INFO - TIMER:&#39;sum&#39; args:[[], []] (100 runs) took 0:00:00.033967 sec
2021-03-06 22:41:38,002 - pyg - INFO - TIMER:&#39;mean&#39; args:[[], []] (100 runs) took 0:00:00.059981 sec
2021-03-06 22:41:38,075 - pyg - INFO - TIMER:&#39;std&#39; args:[[], []] (100 runs) took 0:00:00.071959 sec
2021-03-06 22:41:38,245 - pyg - INFO - TIMER:&#39;min&#39; args:[[], []] (100 runs) took 0:00:00.168553 sec
2021-03-06 22:41:39,523 - pyg - INFO - TIMER:&#39;median&#39; args:[[], []] (100 runs) took 0:00:01.277246 sec
2021-03-06 22:41:39,620 - pyg - INFO - TIMER:&#39;ewma&#39; args:[[&#34;&lt;class &#39;pandas.core.series.Series&#39;&gt;[10000]&#34;, &#39;10&#39;], []] (100 runs) took 0:00:00.094945 sec
2021-03-06 22:41:39,732 - pyg - INFO - TIMER:&#39;ewmstd&#39; args:[[&#34;&lt;class &#39;pandas.core.series.Series&#39;&gt;[10000]&#34;, &#39;10&#39;], []] (100 runs) took 0:00:00.110924 sec
2021-03-06 22:41:39,827 - pyg - INFO - TIMER:&#39;ewmvar&#39; args:[[&#34;&lt;class &#39;pandas.core.series.Series&#39;&gt;[10000]&#34;, &#39;10&#39;], []] (100 runs) took 0:00:00.093965 sec
2021-03-06 22:41:39,855 - pyg - INFO - TIMER:&#39;mean&#39; args:[[], []] (100 runs) took 0:00:00.026971 sec
2021-03-06 22:41:39,953 - pyg - INFO - TIMER:&#39;std&#39; args:[[], []] (100 runs) took 0:00:00.096954 sec
2021-03-06 22:41:39,995 - pyg - INFO - TIMER:&#39;var&#39; args:[[], []] (100 runs) took 0:00:00.039983 sec
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
op              |pandas        |pyg           |winner
rolling_sum     |0:00:00.079685|0:00:00.109934|pandas
rolling_mean    |0:00:00.112599|0:00:00.087950|pyg
rolling_std     |0:00:00.119877|0:00:00.090944|pyg
rolling_min     |0:00:00.100942|0:00:00.119930|draw
rolling_median  |0:00:00.688107|0:00:00.153483|pyg
expanding_sum   |0:00:00.033967|0:00:00.086951|pandas
expanding_mean  |0:00:00.059981|0:00:00.059966|draw
expanding_std   |0:00:00.071959|0:00:00.120938|pandas
expanding_min   |0:00:00.168553|0:00:00.040991|pyg
expanding_median|0:00:01.277246|0:00:00.206892|pyg
ewma            |0:00:00.026971|0:00:00.094945|pandas
ewmstd          |0:00:00.096954|0:00:00.110924|draw
ewmvar          |0:00:00.039983|0:00:00.093965|pandas
</pre></div></div>
</div>
</div>
</div>
<div class="section" id="pyg-and-numpy-arrays">
<h2>pyg and numpy arrays<a class="headerlink" href="#pyg-and-numpy-arrays" title="Permalink to this headline">¶</a></h2>
<p>pyg supports numpy arrays natively. Indeed, pyg is 3-5 times faster on numpy arrays.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">a</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">values</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ts_count</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="n">ts_count</span><span class="p">(</span><span class="n">s</span><span class="p">))</span><span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ts_mean</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="n">ts_mean</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>  <span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ts_sum</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>  <span class="o">-</span> <span class="n">ts_sum</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>   <span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ts_std</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>  <span class="o">-</span> <span class="n">ts_std</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>   <span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ts_skew</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="n">ts_skew</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>  <span class="o">&lt;</span> <span class="mf">1e-10</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ewma</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="n">ewma</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>                    <span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ewmstd</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="n">ewmstd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>                <span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ewmvar</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="n">ewmvar</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>                <span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ewmcor</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="n">ewmcor</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>  <span class="o">&lt;</span> <span class="mf">1e-10</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">expanding_sum</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">-</span> <span class="n">expanding_sum</span><span class="p">(</span><span class="n">a</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>               <span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">expanding_min</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">-</span> <span class="n">expanding_min</span><span class="p">(</span><span class="n">a</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>               <span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">expanding_max</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">-</span> <span class="n">expanding_max</span><span class="p">(</span><span class="n">a</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>               <span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">expanding_mean</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">-</span> <span class="n">expanding_mean</span><span class="p">(</span><span class="n">a</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>             <span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">expanding_std</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">-</span> <span class="n">expanding_std</span><span class="p">(</span><span class="n">a</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>               <span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">expanding_skew</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">-</span> <span class="n">expanding_skew</span><span class="p">(</span><span class="n">a</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>             <span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">expanding_median</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">-</span> <span class="n">expanding_median</span><span class="p">(</span><span class="n">a</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>         <span class="o">&lt;</span> <span class="mf">1e-10</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rolling_sum</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="n">rolling_sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>               <span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rolling_min</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="n">rolling_min</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>               <span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rolling_max</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="n">rolling_max</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>               <span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rolling_mean</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="n">rolling_mean</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>             <span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rolling_std</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="n">rolling_std</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>               <span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rolling_skew</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="n">rolling_skew</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>             <span class="o">&lt;</span> <span class="mf">1e-10</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rolling_median</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="n">rolling_median</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>         <span class="o">&lt;</span> <span class="mf">1e-10</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="pandas-treatment-of-nan">
<h2>pandas treatment of nan<a class="headerlink" href="#pandas-treatment-of-nan" title="Permalink to this headline">¶</a></h2>
<p>Suppose we have weekly data that at some point we resample to daily… The two look the same…</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">t0</span> <span class="o">=</span> <span class="n">dt_bump</span><span class="p">(</span><span class="s1">&#39;20210301&#39;</span><span class="p">,</span> <span class="s1">&#39;-999w&#39;</span><span class="p">)</span>
<span class="n">days</span> <span class="o">=</span> <span class="n">drange</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span><span class="s1">&#39;20210301&#39;</span><span class="p">,</span><span class="s1">&#39;1b&#39;</span><span class="p">)</span>
<span class="n">weekly</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1000</span><span class="p">),</span> <span class="n">drange</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;1w&#39;</span><span class="p">));</span> <span class="n">weekly</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;weekly&#39;</span>
<span class="n">daily</span> <span class="o">=</span> <span class="n">weekly</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">days</span><span class="p">);</span> <span class="n">daily</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;daily&#39;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">weekly</span><span class="p">,</span><span class="n">daily</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>weekly</th>
      <th>daily</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2002-01-07</th>
      <td>0.423187</td>
      <td>0.423187</td>
    </tr>
    <tr>
      <th>2002-01-08</th>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2002-01-09</th>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2002-01-10</th>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2002-01-11</th>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2021-02-23</th>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2021-02-24</th>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2021-02-25</th>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2021-02-26</th>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2021-03-01</th>
      <td>1.408439</td>
      <td>1.408439</td>
    </tr>
  </tbody>
</table>
<p>4996 rows × 2 columns</p>
</div></div>
</div>
<p>… but any calculation using the daily will yield a different result from a calculation on the weekly which is then resampled to daily:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">weekly</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">days</span><span class="p">),</span> <span class="n">daily</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">## The result depends on what is done first...</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>weekly</th>
      <th>daily</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2002-01-07</th>
      <td>0.423187</td>
      <td>0.423187</td>
    </tr>
    <tr>
      <th>2002-01-08</th>
      <td>NaN</td>
      <td>0.423187</td>
    </tr>
    <tr>
      <th>2002-01-09</th>
      <td>NaN</td>
      <td>0.423187</td>
    </tr>
    <tr>
      <th>2002-01-10</th>
      <td>NaN</td>
      <td>0.423187</td>
    </tr>
    <tr>
      <th>2002-01-11</th>
      <td>NaN</td>
      <td>0.423187</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2021-02-23</th>
      <td>NaN</td>
      <td>0.178687</td>
    </tr>
    <tr>
      <th>2021-02-24</th>
      <td>NaN</td>
      <td>0.178687</td>
    </tr>
    <tr>
      <th>2021-02-25</th>
      <td>NaN</td>
      <td>0.178687</td>
    </tr>
    <tr>
      <th>2021-02-26</th>
      <td>NaN</td>
      <td>0.178687</td>
    </tr>
    <tr>
      <th>2021-03-01</th>
      <td>0.655222</td>
      <td>1.005474</td>
    </tr>
  </tbody>
</table>
<p>4996 rows × 2 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">weekly</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">days</span><span class="p">),</span> <span class="n">daily</span><span class="o">.</span><span class="n">diff</span><span class="p">()],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">## The result depends on what is done first...</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>weekly</th>
      <th>daily</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2002-01-07</th>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2002-01-08</th>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2002-01-09</th>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2002-01-10</th>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2002-01-11</th>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2021-02-23</th>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2021-02-24</th>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2021-02-25</th>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2021-02-26</th>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2021-03-01</th>
      <td>1.644159</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>4996 rows × 2 columns</p>
</div></div>
</div>
<p>Indeed, for diff, daily.diff() is all nan!</p>
</div>
<div class="section" id="pyg.timeseries-treatment-of-nans">
<h2>pyg.timeseries treatment of nans<a class="headerlink" href="#pyg.timeseries-treatment-of-nans" title="Permalink to this headline">¶</a></h2>
<p>pyg treats nan as if they are not there, so the fact that we resampled the data and introduced lots of nan’s does not affect the calculations. We find this to be a more logical (and less error prone) approach.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">nona</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ewma</span><span class="p">(</span><span class="n">weekly</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">days</span><span class="p">),</span> <span class="n">ewma</span><span class="p">(</span><span class="n">daily</span><span class="p">,</span><span class="mi">4</span><span class="p">)],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">))</span> <span class="c1">## The two match exactly</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2002-01-07</th>
      <td>0.423187</td>
      <td>0.423187</td>
    </tr>
    <tr>
      <th>2002-01-14</th>
      <td>-0.105302</td>
      <td>-0.105302</td>
    </tr>
    <tr>
      <th>2002-01-21</th>
      <td>-0.019371</td>
      <td>-0.019371</td>
    </tr>
    <tr>
      <th>2002-01-28</th>
      <td>0.332137</td>
      <td>0.332137</td>
    </tr>
    <tr>
      <th>2002-02-04</th>
      <td>0.559419</td>
      <td>0.559419</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2021-02-01</th>
      <td>0.369931</td>
      <td>0.369931</td>
    </tr>
    <tr>
      <th>2021-02-08</th>
      <td>0.526351</td>
      <td>0.526351</td>
    </tr>
    <tr>
      <th>2021-02-15</th>
      <td>0.642578</td>
      <td>0.642578</td>
    </tr>
    <tr>
      <th>2021-02-22</th>
      <td>0.466918</td>
      <td>0.466918</td>
    </tr>
    <tr>
      <th>2021-03-01</th>
      <td>0.655222</td>
      <td>0.655222</td>
    </tr>
  </tbody>
</table>
<p>1000 rows × 2 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">nona</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">diff</span><span class="p">(</span><span class="n">weekly</span><span class="p">)</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">days</span><span class="p">),</span> <span class="n">diff</span><span class="p">(</span><span class="n">daily</span><span class="p">)],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">))</span> <span class="c1">## The result depends on what is done first...</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2002-01-14</th>
      <td>-0.951280</td>
      <td>-0.951280</td>
    </tr>
    <tr>
      <th>2002-01-21</th>
      <td>0.632462</td>
      <td>0.632462</td>
    </tr>
    <tr>
      <th>2002-01-28</th>
      <td>0.913911</td>
      <td>0.913911</td>
    </tr>
    <tr>
      <th>2002-02-04</th>
      <td>0.077887</td>
      <td>0.077887</td>
    </tr>
    <tr>
      <th>2002-02-11</th>
      <td>-2.180086</td>
      <td>-2.180086</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2021-02-01</th>
      <td>-0.678079</td>
      <td>-0.678079</td>
    </tr>
    <tr>
      <th>2021-02-08</th>
      <td>1.049093</td>
      <td>1.049093</td>
    </tr>
    <tr>
      <th>2021-02-15</th>
      <td>-0.044543</td>
      <td>-0.044543</td>
    </tr>
    <tr>
      <th>2021-02-22</th>
      <td>-1.343206</td>
      <td>-1.343206</td>
    </tr>
    <tr>
      <th>2021-03-01</th>
      <td>1.644159</td>
      <td>1.644159</td>
    </tr>
  </tbody>
</table>
<p>999 rows × 2 columns</p>
</div></div>
</div>
</div>
<div class="section" id="Using-pyg.timeseries-to-manage-state">
<h2>Using pyg.timeseries to manage state<a class="headerlink" href="#Using-pyg.timeseries-to-manage-state" title="Permalink to this headline">¶</a></h2>
<p>One of the problem in timeseries analysis is writing research code that works in analysing past data but ideally, the same code can be used in live application. One easy approach is “stick the extra data point at the end and run it again from 1980”. This leaves us with a single code base but for many live applications (e.g. live trading), this is not viable.</p>
<p>Further, given our positions today, we may want to run simulations of “what happens next?” to understand what the system is likely to do should various events occur. Risk calculations are expensive and re-running 10k Monte Carlo scenarios, each time running from 1980 is expensive.</p>
<p>Conversely, we can run research and live systems on two separate code base. This makes live systems responsive but six months down the line, we realise research code base and live code base did not do quite the same thing.</p>
<p>pyg approaches this problem by exposing the internal state of each of its calculation. Each function has two versions:</p>
<ul class="simple">
<li><p>function(…) returns the calculation as performed by pandas</p></li>
<li><p>function_(…) returns a dictionary of dict(data = , state = ). The data agrees with function(…) while the state is a dict we can instantiate new calculations with.</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">pyg</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1000</span><span class="p">),</span> <span class="n">drange</span><span class="p">(</span><span class="o">-</span><span class="mi">1000</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="n">history_signal</span> <span class="o">=</span> <span class="n">ewma_</span><span class="p">(</span><span class="n">history</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">history_signal</span> <span class="c1"># The output consists of &#39;data&#39; and &#39;state&#39; where data matches a normal ewma calculation</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;data&#39;: 2018-06-10   -0.511500
 2018-06-11    0.445609
 2018-06-12   -0.065606
 2018-06-13   -0.358735
 2018-06-14   -0.069188
                 ...
 2021-03-01   -0.144503
 2021-03-02   -0.066708
 2021-03-03   -0.141431
 2021-03-04   -0.122797
 2021-03-05   -0.051610
 Length: 1000, dtype: float64,
 &#39;state&#39;: {&#39;t&#39;: nan, &#39;t0&#39;: 0.9999999999999994, &#39;t1&#39;: -0.05161000819451757}}
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">live</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span> <span class="n">drange</span><span class="p">(</span><span class="mi">9</span><span class="p">))</span>
<span class="n">live_signal</span> <span class="o">=</span> <span class="n">ewma</span><span class="p">(</span><span class="n">live</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">history_signal</span><span class="o">.</span><span class="n">state</span><span class="p">)</span> <span class="c1">## I only feed in live timeseries</span>
<span class="s1">&#39;live: from today onwards&#39;</span><span class="p">,</span> <span class="n">live_signal</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(&#39;live: from today onwards&#39;,
 2021-03-06   -0.059815
 2021-03-07   -0.165151
 2021-03-08   -0.104525
 2021-03-09   -0.160978
 2021-03-10   -0.224791
 2021-03-11   -0.325723
 2021-03-12   -0.207468
 2021-03-13   -0.233642
 2021-03-14   -0.228141
 2021-03-15   -0.244483
 dtype: float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">joint_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">history</span><span class="p">,</span> <span class="n">live</span><span class="p">])</span>
<span class="n">joint_signal</span> <span class="o">=</span> <span class="n">ewma</span><span class="p">(</span><span class="n">joint_data</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">eq</span><span class="p">(</span><span class="n">live_signal</span><span class="p">,</span> <span class="n">joint_signal</span><span class="p">[</span><span class="n">dt</span><span class="p">(</span><span class="mi">0</span><span class="p">):])</span>  <span class="c1"># The live signal is the same, even though it only received live data for its calculation.</span>
<span class="n">joint_signal</span><span class="p">[</span><span class="n">dt</span><span class="p">(</span><span class="mi">0</span><span class="p">):]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
2021-03-06   -0.059815
2021-03-07   -0.165151
2021-03-08   -0.104525
2021-03-09   -0.160978
2021-03-10   -0.224791
2021-03-11   -0.325723
2021-03-12   -0.207468
2021-03-13   -0.233642
2021-03-14   -0.228141
2021-03-15   -0.244483
dtype: float64
</pre></div></div>
</div>
<p>This allows us to set up three parallel pipelines that share a virtually identical codebase:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 29%" />
<col style="width: 30%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>workflow</p></th>
<th class="head"><p>historic data</p></th>
<th class="head"><p>live data</p></th>
<th class="head"><p>risk analysis</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>when run?</p></td>
<td><p>research/overnight</p></td>
<td><p>live</p></td>
<td><p>overnight</p></td>
</tr>
<tr class="row-odd"><td><p>data source?</p></td>
<td><p>ts = long timeseries</p></td>
<td><p>a = short ts/array</p></td>
<td><p>1000’s of sims</p></td>
</tr>
<tr class="row-even"><td><p>speed?</p></td>
<td><p>slow, non-critical</p></td>
<td><p>instantenous</p></td>
<td><p>quick</p></td>
</tr>
<tr class="row-odd"><td><p>apply f to data</p></td>
<td><p>x_ = f_(ts)</p></td>
<td><p>x = f(a, **x_)</p></td>
<td><p>same as live</p></td>
</tr>
<tr class="row-even"><td><p>apply g</p></td>
<td><p>y_ = g_(ts, <a href="#id1"><span class="problematic" id="id2">x_</span></a>)</p></td>
<td><p>y = g(a, x, **y_)</p></td>
<td><p>same as live</p></td>
</tr>
<tr class="row-odd"><td><p>final result h</p></td>
<td><p>z_ = h_(ts, <a href="#id3"><span class="problematic" id="id4">x_</span></a>, <a href="#id5"><span class="problematic" id="id6">y_</span></a>)</p></td>
<td><p>z = h(a, x, y, **z_)</p></td>
<td><p>same as live</p></td>
</tr>
</tbody>
</table>
<p>Note that for live trading or risk analysis, we tend to switch and run on numpy arrays rather than pandas object. This speeds up the calculations while introduces no code change. In the example below we explore how to create state-aware, functions within pyg. The paradigm is that for most functions, function_ will return not just the timeseries output but also the states.</p>
<div class="section" id="Example:-creating-a-function-exposing-its-state">
<h3>Example: creating a function exposing its state<a class="headerlink" href="#Example:-creating-a-function-exposing-its-state" title="Permalink to this headline">¶</a></h3>
<p>Suppose we try to write an ewma crossover function (the difference of two ewma). We want to normalize it by its own volatility. Traditionally we will write:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">pandas_crossover</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">fast</span><span class="p">,</span> <span class="n">slow</span><span class="p">,</span> <span class="n">vol</span><span class="p">):</span>
    <span class="n">fast_ewma</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">fast</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">slow_ewma</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">slow</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">raw_signal</span> <span class="o">=</span> <span class="n">fast_ewma</span> <span class="o">-</span> <span class="n">slow_ewma</span>
    <span class="n">signal_rms</span> <span class="o">=</span> <span class="p">(</span><span class="n">raw_signal</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">vol</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">**</span><span class="mf">0.5</span>
    <span class="n">signal_rms</span><span class="p">[</span><span class="n">signal_rms</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">normalized</span> <span class="o">=</span> <span class="n">raw_signal</span><span class="o">/</span><span class="n">signal_rms</span>
    <span class="k">return</span> <span class="n">normalized</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">10000</span><span class="p">),</span> <span class="n">drange</span><span class="p">(</span><span class="o">-</span><span class="mi">9999</span><span class="p">));</span> <span class="n">fast</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="n">slow</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span> <span class="n">vol</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">pandas_x</span> <span class="o">=</span> <span class="n">pandas_crossover</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">fast</span><span class="p">,</span> <span class="n">slow</span><span class="p">,</span> <span class="n">vol</span><span class="p">)</span>
<span class="n">pandas_x</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1993-10-20         NaN
1993-10-21   -1.407264
1993-10-22   -1.714259
1993-10-23    1.177760
1993-10-24   -1.220600
                ...
2021-03-02   -1.767405
2021-03-03   -1.183420
2021-03-04   -1.764486
2021-03-05   -2.458497
2021-03-06   -2.242366
Length: 10000, dtype: float64
</pre></div></div>
</div>
<p>We can quickly rewrite it using pyg:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">crossover</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">fast</span><span class="p">,</span> <span class="n">slow</span><span class="p">,</span> <span class="n">vol</span><span class="p">):</span>
    <span class="n">fast_ewma</span> <span class="o">=</span> <span class="n">ewma</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">fast</span><span class="p">)</span>
    <span class="n">slow_ewma</span> <span class="o">=</span> <span class="n">ewma</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">slow</span><span class="p">)</span>
    <span class="n">raw_signal</span> <span class="o">=</span> <span class="n">fast_ewma</span> <span class="o">-</span> <span class="n">slow_ewma</span>
    <span class="n">signal_rms</span> <span class="o">=</span> <span class="n">ewmrms</span><span class="p">(</span><span class="n">raw_signal</span><span class="p">,</span> <span class="n">vol</span><span class="p">)</span>
    <span class="n">signal_rms</span> <span class="o">=</span> <span class="n">v2na</span><span class="p">(</span><span class="n">signal_rms</span><span class="p">)</span>
    <span class="n">normalized</span> <span class="o">=</span> <span class="n">raw_signal</span><span class="o">/</span><span class="n">signal_rms</span>
    <span class="k">return</span> <span class="n">normalized</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">crossover</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">fast</span><span class="p">,</span> <span class="n">slow</span><span class="p">,</span> <span class="n">vol</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">pandas_x</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">&lt;</span><span class="mf">1e-10</span>
<span class="n">x</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1993-10-20   -1.000000
1993-10-21   -1.407264
1993-10-22   -1.714259
1993-10-23    1.177760
1993-10-24   -1.220600
                ...
2021-03-02   -1.767405
2021-03-03   -1.183420
2021-03-04   -1.764486
2021-03-05   -2.458497
2021-03-06   -2.242366
Length: 10000, dtype: float64
</pre></div></div>
</div>
<p>And with very little additional effort, we can write a new function that also exposes the internal state:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">_data</span> <span class="o">=</span> <span class="s1">&#39;data&#39;</span>
<span class="k">def</span> <span class="nf">crossover_</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">fast</span><span class="p">,</span> <span class="n">slow</span><span class="p">,</span> <span class="n">vol</span><span class="p">,</span> <span class="n">instate</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">(</span><span class="n">fast</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">slow</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">vol</span> <span class="o">=</span> <span class="p">{})</span> <span class="k">if</span> <span class="n">instate</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">instate</span>
    <span class="n">fast_ewma_</span> <span class="o">=</span> <span class="n">ewma_</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">fast</span><span class="p">,</span> <span class="n">instate</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">fast</span><span class="p">)</span>
    <span class="n">slow_ewma_</span> <span class="o">=</span> <span class="n">ewma_</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">slow</span><span class="p">,</span> <span class="n">instate</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">slow</span><span class="p">)</span>
    <span class="n">raw_signal</span> <span class="o">=</span> <span class="n">fast_ewma_</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span> <span class="n">slow_ewma_</span><span class="o">.</span><span class="n">data</span>
    <span class="n">signal_rms</span> <span class="o">=</span> <span class="n">ewmrms_</span><span class="p">(</span><span class="n">raw_signal</span><span class="p">,</span> <span class="n">vol</span><span class="p">,</span> <span class="n">instate</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">vol</span><span class="p">)</span>
    <span class="n">normalized</span> <span class="o">=</span> <span class="n">raw_signal</span><span class="o">/</span><span class="n">v2na</span><span class="p">(</span><span class="n">signal_rms</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Dict</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">normalized</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">(</span><span class="n">fast</span> <span class="o">=</span> <span class="n">fast_ewma_</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">slow</span> <span class="o">=</span> <span class="n">slow_ewma_</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">vol</span> <span class="o">=</span> <span class="n">signal_rms</span><span class="o">.</span><span class="n">state</span><span class="p">))</span>

<span class="n">crossover_</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="c1"># output declares the function to have a dict output and is used by cell</span>

<span class="k">def</span> <span class="nf">crossover</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">fast</span><span class="p">,</span> <span class="n">slow</span><span class="p">,</span> <span class="n">vol</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">crossover_</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">fast</span><span class="p">,</span> <span class="n">slow</span><span class="p">,</span> <span class="n">vol</span><span class="p">,</span> <span class="n">instate</span> <span class="o">=</span> <span class="n">state</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>

<span class="n">x_</span> <span class="o">=</span> <span class="n">crossover_</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">fast</span><span class="p">,</span> <span class="n">slow</span><span class="p">,</span> <span class="n">vol</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">eq</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x_</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="ow">and</span> <span class="n">eq</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">crossover</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">fast</span><span class="p">,</span> <span class="n">slow</span><span class="p">,</span> <span class="n">vol</span><span class="p">))</span>
<span class="n">x_</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1993-10-20   -1.000000
1993-10-21   -1.407264
1993-10-22   -1.714259
1993-10-23    1.177760
1993-10-24   -1.220600
                ...
2021-03-02   -1.767405
2021-03-03   -1.183420
2021-03-04   -1.764486
2021-03-05   -2.458497
2021-03-06   -2.242366
Length: 10000, dtype: float64
</pre></div></div>
</div>
<p>The three give idential results and we can also verify that crossover_ will allow us to split the evaluation to the long-history and the new data:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">history</span> <span class="o">=</span> <span class="n">a</span><span class="p">[:</span><span class="mi">9900</span><span class="p">]</span>
<span class="n">live</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">9900</span><span class="p">:]</span><span class="o">.</span><span class="n">values</span>
<span class="n">x_history</span> <span class="o">=</span> <span class="n">crossover_</span><span class="p">(</span><span class="n">history</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">x_live</span> <span class="o">=</span> <span class="n">crossover</span><span class="p">(</span><span class="n">live</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">x_history</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
<span class="n">x_</span> <span class="o">=</span> <span class="n">crossover_</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">fast</span><span class="p">,</span> <span class="n">slow</span><span class="p">,</span> <span class="n">vol</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">eq</span><span class="p">(</span><span class="n">x_live</span> <span class="p">,</span> <span class="n">x_</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">9900</span><span class="p">:]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Have we gained anything?</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">pandas_old</span> <span class="o">=</span> <span class="n">timer</span><span class="p">(</span><span class="n">pandas_crossover</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">time</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)(</span><span class="n">history</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">x_history</span>  <span class="o">=</span> <span class="n">crossover_</span><span class="p">(</span><span class="n">history</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">x_history_time</span>  <span class="o">=</span> <span class="n">timer</span><span class="p">(</span><span class="n">crossover_</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">time</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)(</span><span class="n">history</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">x_live</span> <span class="o">=</span> <span class="n">timer</span><span class="p">(</span><span class="n">crossover</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">time</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)(</span><span class="n">live</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">x_history</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
<span class="s1">&#39;pandas: &#39;</span><span class="p">,</span> <span class="n">pandas_old</span><span class="o">.</span><span class="n">microseconds</span><span class="o">//</span><span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;pyg history:&#39;</span><span class="p">,</span> <span class="n">x_history_time</span><span class="o">.</span><span class="n">microseconds</span><span class="o">//</span><span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;pyg_live:&#39;</span><span class="p">,</span> <span class="n">x_live</span><span class="o">.</span><span class="n">microseconds</span><span class="o">//</span><span class="mi">1000</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
2021-03-06 23:55:39,746 - pyg - INFO - TIMER:&#39;pandas_crossover&#39; args:[[&#34;&lt;class &#39;pandas.core.series.Series&#39;&gt;[9900]&#34;, &#39;10&#39;, &#39;30&#39;, &#39;50&#39;], []] (100 runs) took 0:00:00.373514 sec
2021-03-06 23:55:39,953 - pyg - INFO - TIMER:&#39;crossover_&#39; args:[[&#34;&lt;class &#39;pandas.core.series.Series&#39;&gt;[9900]&#34;, &#39;10&#39;, &#39;30&#39;, &#39;50&#39;], []] (100 runs) took 0:00:00.202883 sec
2021-03-06 23:55:40,004 - pyg - INFO - TIMER:&#39;crossover&#39; args:[[&#34;&lt;class &#39;numpy.ndarray&#39;&gt;[100]&#34;, &#39;10&#39;, &#39;30&#39;, &#39;50&#39;], [&#34;state=&lt;class &#39;pyg.base._dict.Dict&#39;&gt;[3]&#34;]] (100 runs) took 0:00:00.049972 sec
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(&#39;pandas: &#39;, 373, &#39;pyg history:&#39;, 202, &#39;pyg_live:&#39;, 49)
</pre></div></div>
</div>
<p>We see that pyg is already faster than pandas. Running just the new data using numpy arrays, is about 4-5 times faster still. Indeed, running 10k 100-day forward scenarios take about 2 seconds at most.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">scenarios</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,(</span><span class="mi">100</span><span class="p">,</span><span class="mi">10000</span><span class="p">))</span>
<span class="n">x_scenarios</span> <span class="o">=</span> <span class="n">timer</span><span class="p">(</span><span class="n">crossover</span><span class="p">)(</span><span class="n">scenarios</span> <span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">x_history</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
2021-03-06 23:56:10,252 - pyg - INFO - TIMER:&#39;crossover&#39; args:[[&#34;&lt;class &#39;numpy.ndarray&#39;&gt;[100]&#34;, &#39;10&#39;, &#39;30&#39;, &#39;50&#39;], [&#34;state=&lt;class &#39;pyg.base._dict.Dict&#39;&gt;[3]&#34;]] (1 runs) took 0:00:01.605710 sec
</pre></div></div>
</div>
<p>Using cells, our code looks like this, with live and historical codebase looking pretty similar</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">x_history</span> <span class="o">=</span> <span class="n">cell</span><span class="p">(</span><span class="n">crossover_</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">history</span><span class="p">,</span> <span class="n">fast</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">slow</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> <span class="n">vol</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)()</span>
<span class="n">x_live</span> <span class="o">=</span> <span class="n">cell</span><span class="p">(</span><span class="n">crossover</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">live</span><span class="p">,</span> <span class="n">fast</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">slow</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> <span class="n">vol</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">x_history</span><span class="p">)()</span>
<span class="n">x_history</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
cell
a:
    1993-10-20    0.463739
    1993-10-21    0.429161
    1993-10-22   -0.342095
    1993-10-23    1.192557
    1993-10-24   -0.448828
                    ...
    2020-11-22   -0.272184
    2020-11-23    0.121197
    2020-11-24   -0.581223
    2020-11-25   -0.682961
    2020-11-26   -1.084583
    Length: 9900, dtype: float64
fast:
    10
slow:
    30
vol:
    50
function:
    &lt;function crossover_ at 0x000001CF9B58BA60&gt;
instate:
    None
data:
    1993-10-20   -1.000000
    1993-10-21   -1.407264
    1993-10-22   -1.714259
    1993-10-23    1.177760
    1993-10-24   -1.220600
                    ...
    2020-11-22   -2.091785
    2020-11-23   -1.765958
    2020-11-24   -1.796933
    2020-11-25   -1.853106
    2020-11-26   -2.044795
    Length: 9900, dtype: float64
state:
    Dict
    fast:
        {&#39;t&#39;: nan, &#39;t0&#39;: 0.9999999999999994, &#39;t1&#39;: -0.4251894284980144}
    slow:
        {&#39;t&#39;: nan, &#39;t0&#39;: 0.9999999999999983, &#39;t1&#39;: -0.14408421908740027}
    vol:
        {&#39;t&#39;: nan, &#39;t0&#39;: 0.9999999999999972, &#39;t2&#39;: 0.01889897942675779}
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">x_live</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">pandas_x</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">100</span><span class="p">:]),</span> <span class="n">pandas_x</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">100</span><span class="p">:]],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-11-27</th>
      <td>-2.466036</td>
      <td>-2.466036</td>
    </tr>
    <tr>
      <th>2020-11-28</th>
      <td>-1.899795</td>
      <td>-1.899795</td>
    </tr>
    <tr>
      <th>2020-11-29</th>
      <td>-1.573653</td>
      <td>-1.573653</td>
    </tr>
    <tr>
      <th>2020-11-30</th>
      <td>-1.473624</td>
      <td>-1.473624</td>
    </tr>
    <tr>
      <th>2020-12-01</th>
      <td>-1.978180</td>
      <td>-1.978180</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2021-03-02</th>
      <td>-1.767405</td>
      <td>-1.767405</td>
    </tr>
    <tr>
      <th>2021-03-03</th>
      <td>-1.183420</td>
      <td>-1.183420</td>
    </tr>
    <tr>
      <th>2021-03-04</th>
      <td>-1.764486</td>
      <td>-1.764486</td>
    </tr>
    <tr>
      <th>2021-03-05</th>
      <td>-2.458497</td>
      <td>-2.458497</td>
    </tr>
    <tr>
      <th>2021-03-06</th>
      <td>-2.242366</td>
      <td>-2.242366</td>
    </tr>
  </tbody>
</table>
<p>100 rows × 2 columns</p>
</div></div>
</div>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">pyg</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../includeme.html">README</a></li>
<li class="toctree-l1"><a class="reference internal" href="../base.html">pyg.base</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mongo.html">pyg.mongo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timeseries.html">pyg.timeseries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_dict.html">pyg.base.Dict</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_dictable.html">pyg.base.dictable</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_mongo.html">pyg.mongo</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_cell.html">pyg.base.cell</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_perdictable.html">pyg.base.join</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">pyg.timeseries</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Agreement-between-pyg.timeseries-and-pandas">Agreement between pyg.timeseries and pandas</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Quick-performance-comparison">Quick performance comparison</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#pyg-and-numpy-arrays">pyg and numpy arrays</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pandas-treatment-of-nan">pandas treatment of nan</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pyg.timeseries-treatment-of-nans">pyg.timeseries treatment of nans</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Using-pyg.timeseries-to-manage-state">Using pyg.timeseries to manage state</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Example:-creating-a-function-exposing-its-state">Example: creating a function exposing its state</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_ts_decorators.html">pyg.timeseries decorators</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_ts_ewma_time.html">pyg.timeseries.ewma</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="tutorial_perdictable.html" title="previous chapter">pyg.base.join</a></li>
      <li>Next: <a href="tutorial_ts_decorators.html" title="next chapter">pyg.timeseries decorators</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Yoav Git.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.4.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/lab/tutorial_timeseries.ipynb.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>